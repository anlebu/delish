<!--http://www.cnn.com/2018/01/05/politics/trump-dow-jones-interactive/index.html
https://bl.ocks.org/d3noob/4db972df5d7efc7d611255d1cc6f3c4f
https://leanpub.com/d3-t-and-t-v4/read-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Assignment 1</title>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="/scripts/multiline.js" charset="utf-8"></script>
    <style>
        /* set the CSS */
        .line {
            fill: none;
            stroke: lightgray;
            stroke-width: 2px;
        }

        .line--fade {
            opacity: 0.8;
        }

        .line--hover {
            stroke: url(#line-gradient);
        }

        .lineTrump {
            fill: none;
            stroke: red;
            stroke-width: 2px;
        }

        .grid line {
            stroke: lightgrey;
            stroke-dasharray: 2 2;
            stroke-opacity: 0.7;
            stroke-width: 2px;
            shape-rendering: crispEdges;
        }

        .grid path {
            stroke-width: 0;
        }


        .rightLabel {
            fill: lightgrey;
            font-size: xx-small;
            font-weight: bolder;
            stroke: white;
            stroke-width: .1px;
        }

        .rightLabel--fade {
            opacity: 0.8;
        }

        .rightLabel--hover {
            fill: black;
            font-size: x-small;
        }

        .Yaxis path {
            stroke: none;
        }

        .Xaxis line {
            stroke: none;
        }

        .Xaxis path {
            stroke: none;
        }

        .overlay {
            fill: none;
            pointer-events: all;
        }

        .focus1 {
            fill: black;
            font-size: large;
            font-weight: bold;
            stroke: white;
            stroke-width: .2px;
        }

    </style>
</head>

<body>
    <h1>Assignment 1 and 2</h1>
    <h2>First year in office stock market performance by President</h2>
    <div class="target1" id="target1"></div>
    <script type="text/javascript">

        // set the dimensions and margins of the graph
        var margin = { top: 20, right: 150, bottom: 30, left: 50 },
            width = 800 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;
        var x = d3.scaleLinear().range([0, width]);
        var y = d3.scaleLinear().range([height, 0]);

        // append the svg obgect to the body of the page
        // appends a 'group' element to 'svg'
        // moves the 'group' element to the top left margin
        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

        // gridlines in x axis function
        function make_x_gridlines() {
            return d3.axisBottom(x)
        }

        // gridlines in y axis function
        function make_y_gridlines() {
            return d3.axisLeft(y)
        }

        d3.json("/data/stockMarketPerformanceData.json", function (data) {

            //convert all properties to numbers
            data.forEach(function (object) {
                for (var property in object) {

                    if (object.hasOwnProperty(property)) {
                        object[property] = +object[property];

                    }
                }
            });

            // Scale the range of the data
            x.domain([0, 242]);
            y.domain([-0.40, 0.84]);

            // add the X gridlines
            svg.append("g")
                .attr("class", "grid")
                .attr("transform", "translate(0," + height + ")")
                .call(make_x_gridlines()
                    .tickSize(-height)
                    .tickFormat("")
                )

            // add the Y gridlines
            svg.append("g")
                .attr("class", "grid")
                .call(make_y_gridlines()
                    .ticks(6)
                    .tickSize(-width)
                    .tickFormat("")
                )

            //define custom line gardien to be usd on the line color on mouse over
            svg.append("linearGradient")
                .attr("id", "line-gradient")
                .attr("gradientUnits", "userSpaceOnUse")
                .attr("x1", 0).attr("y1", y(0.1))//need a from to range for the gardient
                .attr("x2", 0).attr("y2", y(-0.1))//need a from to range for the gardient
                .selectAll("stop")
                .data([
                    { offset: "0%", color: "rgb(59,193,203)" },
                    { offset: "50%", color: "rgb(59,193,203)" },
                    { offset: "50%", color: "rgb(241,31,117)" },
                    { offset: "100%", color: "rgb(241,31,117)" }
                ])
                .enter().append("stop")
                .attr("offset", function (d) { return d.offset; })
                .attr("stop-color", function (d) { return d.color; });

            //add title label
            var label1 = svg.append("g");
            label1.append("text").text("dow jones change since taking office")
                .attr("transform", "translate(5,5)")

            //add point label and text
            var focus = svg.append("g")
                .attr("class", "focus");
                       
            focus.append("g")
                .attr("class", "focus1")
                .append("circle")
                .style("stroke", "black")
                .style("fill", "white")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .attr("r", 4);
            svg.select(".focus1")
                .append("text")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .attr("x", 9)
                .attr("dy", ".55em");

            svg.append("rect")
                .attr("class", "overlay")
                .attr("width", width)
                .attr("height", height)
                //.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .on("mouseover", function () { focus.style("display", null); })
                .on("mouseout", function () { focus.style("display", "none"); })
                .on("mousemove", mousemove);

            function mousemove() {
                var x0 = x.invert(d3.mouse(this)[0]);
                var y0 = y.invert(d3.mouse(this)[1]);
                var i = 0;
                //find the closest date to the mouse x location
                for (i = 0; i < data.length; i++) {
                    if (data[i].date >= x0) break;
                }

                //find the closest president to the mouse y location on the x location
                let object = data[i];
                let csslinelocator = "nothingRandom123";
                let lowestVariance = 100;//larger than max variance to init
                var propertyValue = 0;
                for (var property in object) {

                    if (object.hasOwnProperty(property)) {

                        if (property != "date") {

                            if (Math.abs(object[property] - y0) < lowestVariance) {
                                lowestVariance = Math.abs(object[property] - y0);
                                csslinelocator = property.replace(/\s/g, '');
                                propertyValue = object[property];
                            }

                        }
                    }
                }

                //reset
                d3.selectAll(".lineTrump").raise();
                d3.selectAll(".line")
                    .classed("line--hover", false)
                    .classed("line--fade", false);
                d3.selectAll(".rightLabel")
                    .classed("rightLabel--hover", false)
                    .classed("rightLabel--fade", false);

                //select
                d3.selectAll(".lineTrump").raise();
                d3.selectAll("." + csslinelocator).raise();//make the line the top object to prevent other lines from hidding it
                d3.selectAll("#axis0").raise();

                d3.selectAll(".line").classed("line--hover", function () {//set the line classes
                    let colClass2 = d3.select(this).attr("class");
                    let classes2 = colClass2.split(" ");//the first class is the line locator


                    return (csslinelocator === classes2[0]);
                }).classed("line--fade", function () {
                    let colClass2 = d3.select(this).attr("class");
                    let classes2 = colClass2.split(" ");//the first class is the line locator
                    return (csslinelocator !== classes2[0]);
                });

                d3.selectAll(".rightLabel").classed("rightLabel--hover", function () {//set the line classes
                    let colClass2 = d3.select(this).attr("class");
                    let classes2 = colClass2.split(" ");//the first class is the line locator
                    return (csslinelocator === classes2[0]);
                }).classed("rightLabel--fade", function () {
                    let colClass2 = d3.select(this).attr("class");
                    let classes2 = colClass2.split(" ");//the first class is the line locator
                    return (csslinelocator !== classes2[0]);
                });

                var selectedFocus = svg.selectAll(".focus1");
                console.log(data[i].date);
                console.log(x(data[i].date));

                selectedFocus.attr("transform", "translate(" + (x(data[i].date) - margin.left) + "," + (y(propertyValue) - margin.top) + ")");
                selectedFocus.select("text").text(Math.round(propertyValue * 100) + "%");
                d3.selectAll(".focus").raise();
                d3.selectAll(".overlay").raise();
            }

            function mouseover(d, i) {
                var me = this;

                //get the csslinelocator
                var colClass = d3.select(me).attr("class");
                var classes = colClass.split(" ");//the first class is the line locator
                //classes[0]

                d3.selectAll(".lineTrump").raise();
                d3.selectAll("." + classes[0]).raise();//make the line the top object to prevent other lines from hidding it
                d3.selectAll("#axis0").raise();

                d3.selectAll(".line").classed("line--hover", function () {//set the line classes
                    let colClass2 = d3.select(this).attr("class");
                    let classes2 = colClass2.split(" ");//the first class is the line locator


                    return (classes[0] === classes2[0]);
                }).classed("line--fade", function () {
                    let colClass2 = d3.select(this).attr("class");
                    let classes2 = colClass2.split(" ");//the first class is the line locator
                    return (classes[0] !== classes2[0]);
                });

                d3.selectAll(".rightLabel").classed("rightLabel--hover", function () {//set the line classes
                    let colClass2 = d3.select(this).attr("class");
                    let classes2 = colClass2.split(" ");//the first class is the line locator
                    return (classes[0] === classes2[0]);
                }).classed("rightLabel--fade", function () {
                    let colClass2 = d3.select(this).attr("class");
                    let classes2 = colClass2.split(" ");//the first class is the line locator
                    return (classes[0] !== classes2[0]);
                });

            }

            function mouseout(d) {//set the line classes
                d3.selectAll(".lineTrump").raise();
                d3.selectAll(".line")
                    .classed("line--hover", false)
                    .classed("line--fade", false);
                d3.selectAll(".rightLabel")
                    .classed("rightLabel--hover", false)
                    .classed("rightLabel--fade", false);
            }

            //use the first object as the reference to plot all lines
            let object = data[0];
            for (var property in object) {

                if (object.hasOwnProperty(property)) {

                    if (property != "date") {
                        let cssclass = "line";
                        let csslinelocator = property.replace(/\s/g, '');
                        if (property == "Trump") {
                            cssclass = "lineTrump";
                        }
                        cssclass = csslinelocator + " " + cssclass;
                        let valueline2 = d3.line()
                            .x(function (d) { return x(d.date); })
                            .y(function (d) { return y(d[property]); });

                        // Add the valueline path.
                        svg.append("path")
                            .data([data])
                            .attr("class", cssclass)
                            .attr("d", valueline2)

                        svg.append("text")
                            .attr("transform", "translate(" + (width + 3) + "," + y(data[241][property]) + ")")
                            .attr("class", csslinelocator + " rightLabel")
                            .on("mouseover", mouseover)
                            .on("mouseout", mouseout)
                            .text(property)

                    }
                }
            }

            //set Trump on top
            d3.selectAll(".lineTrump").raise();

            // Add the X Axis
            svg.append("g")
                .attr("class", "Xaxis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x));

            // Add the X Axis Line at 0
            svg.append("line")          // attach a line
                .attr("id", "axis0")
                .style("stroke", "black")  // colour the line
                .attr("x1", 0)     // x position of the first end of the line
                .attr("y1", 0)      // y position of the first end of the line
                .attr("x2", width)     // x position of the second end of the line
                .attr("y2", 0)    // y position of the second end of the line
                .attr("transform", "translate(0," + (y(0)) + ")");


            // Add the Y Axis
            svg.append("g")
                .attr("class", "Yaxis")
                .call(d3.axisLeft(y).ticks(6).tickFormat(d => (d * 100) + "%"));

        });


    </script>

</body>
</html>
