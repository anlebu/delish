<!-
https://gis.cdc.gov/GRASP/Fluview/PedFluDeath.html
https://gis.cdc.gov/grasp/fluview/fluportaldashboard.html
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Assignment 3</title>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <style>
        .Yaxis path {
            stroke: darkgrey;
            stroke-width: 6px;
        }
    </style>
</head>

<body>
    <h1>Assignment 3 stacked bar charts</h1> 

    <script type="text/javascript">

        // set the dimensions and margins of the graph
        var margin = { top: 20, right: 150, bottom: 100, left: 50 },
            width = 1800 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;
        var x = d3.scaleBand().range([0, width]).padding(0.1);

        //used for grids on Seasons
        var x2 = d3.scaleBand().range([0, width]).padding(0);

        var y = d3.scaleLinear().range([height, 0]);
        //define colors
        var z = d3.scaleOrdinal()
            .range(["rgb(14,136,240)", "green"]);

        //var x2 = d3.scaleLinear().range([0, width]);
        // append the svg obgect to the target1
        // appends a 'group' element to 'svg'
        // moves the 'group' element to the top left margin
        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Number of Deaths");   

        // text label for the x axis
        svg.append("text")
            .attr("transform",
            "translate(" + (width / 2) + " ," +
            (height + margin.top + 60) + ")")
            .style("text-anchor", "middle")
            .text("Week of Death");



        // Prep the tooltip bits, initial display is hidden
        var tooltip = svg.append("g")
            .attr("class", "tooltip")
            .style("display", "none");

        tooltip.append("rect")
            .attr("class", "tooltipBox")
            .attr("width", 200)
            .attr("height", 60)
            .attr("fill", "white")
            .style("opacity", 0.8);

        tooltip.append("g")
            .attr("class", "focus1")
            .append("circle")
            .style("stroke", "black")
            .style("fill", "white")
            .attr("transform", "translate(0," + 60 + ")")
            .attr("r", 5);

        tooltip.append("text")
            .attr("id", "tool1")
            .attr("x", 10)
            .attr("dy", "1.2em")
            .style("text-anchor", "left")
            .attr("font-size", "12px")
            .attr("font-weight", "bold");
        tooltip.append("text")
            .attr("id", "tool2")
            .attr("x", 10)
            .attr("y", 13)
            .attr("dy", "1.2em")
            .style("text-anchor", "left")
            .attr("font-size", "12px")
            .attr("font-weight", "bold");
        tooltip.append("text")
            .attr("id", "tool3")
            .attr("x", 10)
            .attr("y", 26)
            .attr("dy", "1.2em")
            .style("text-anchor", "left")
            .attr("font-size", "12px")
            .attr("font-weight", "bold");
        tooltip.append("text")
            .attr("id", "tool4")
            .attr("x", 10)
            .attr("y", 39)
            .attr("dy", "1.2em")
            .style("text-anchor", "left")
            .attr("font-size", "12px")
            .attr("font-weight", "bold");

        d3.csv("/data/PedFluDeath_WeeklyData.csv", function (error, data) {
            if (error) throw error;

            //convert all properties to numbers
            data.forEach(function (d) {
                d.WEEKNUMBER = +(d.WEEKNUMBER.substring(0, 4).concat(d.WEEKNUMBER.substring(5, 7)));
                d.CURRENTWEEKDEATHS = +d.CURRENTWEEKDEATHS;
                d.PREVIOUSWEEKSDEATHS = +d.PREVIOUSWEEKSDEATHS;
            });

            // Scale the range of the data in the domains
            x.domain(data.map(function (d) { return d.WEEKNUMBER; }));

            y.domain([0, 18]);

            var SEASONCount = d3.nest()
                .key(function (d) { return d.SEASON; })
                .rollup(function (v) { return v.length; })
                .entries(data);
            console.log(JSON.stringify(SEASONCount));

            x2.domain(SEASONCount.map(function (d) { return d.key; }));

            var grid = svg.append("g")
                .attr("class", "grid");
            grid.selectAll("rect")
                .data(SEASONCount)
                .enter().append("rect")
                .attr("fill",
                function (d) {
                    if (d.key == "2014-15" || d.key == "2016-17") return "white"; else return "rgb(241,241,241)";
                }
                )
                .attr("x", function (d) { return x2(d.key); })
                .attr("y", 0)
                .attr("height", height)
                .attr("width", function (d) { return (width / SEASONCount.length); });
            grid.selectAll("text")
                .data(SEASONCount)
                .enter().append("text")
                .text(function (d) {  return d.key })
                .attr("fill", "black")
                .attr("dy", ".55em")
                .attr("x", function (d) { return x2(d.key)+170; })
                .attr("y", 10);
            
            //Stacked bar charts
            //slice after 2
            var keys = data.columns.slice(2);

            data.sort(function (a, b) { return d3.descending(b.WEEKNUMBER, a.WEEKNUMBER); });
            z.domain(keys);

            svg.append("g")
                .selectAll("g")
                .data(d3.stack().keys(keys).order(d3.stackOrderDescending)(data))
                .enter().append("g")
                .attr("fill", function (d) { return z(d.key); })
                .selectAll("rect")
                .data(function (d) { return d; })
                .enter().append("rect")
                .attr("class", function (d) { return d.key; })
                .attr("x", function (d) { return x(d.data.WEEKNUMBER); })
                .attr("y", function (d) { return y(d[1]); })
                .attr("height", function (d) { return y(d[0]) - y(d[1]); })
                .attr("width", x.bandwidth())
                .on("mouseover", function (d) {
                    if (d[0] == 0 && d.data.PREVIOUSWEEKSDEATHS > 0) {
                        tooltip.select("#tool1").text("Reported - Previous Weeks Count");
                        tooltip.select(".tooltipBox").attr("stroke", "green");
                    }
                    else {
                        tooltip.select("#tool1").text("Reported - Current Weeks Count");
                        tooltip.select(".tooltipBox").attr("stroke", "rgb(14,136,240)");
                    }

                    tooltip.attr("transform", "translate(" + (x(d.data.WEEKNUMBER) + 5) + "," + (y(d[1]) - 60) + ")");
                    tooltip.select("#tool2").text("Season: " + d.data.SEASON);
                    tooltip.select("#tool3").text("Week: " + d.data.WEEKNUMBER);
                    tooltip.select("#tool4").text("No. of Deaths: " + (d[1] - d[0]));
                    tooltip.style("display", null);
                    d3.selectAll(".tooltip").raise();
                })
                .on("mouseout", function () { tooltip.style("display", "none"); })

            
            // Add the X Axis
            svg.append("g")
                .data(data)
                .attr("class", "Xaxis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x)
                    .tickFormat(d => (d / 100).toFixed(2).replace(".", "-"))
                )
                .selectAll("text")
                .data(data)
                .attr("display", function (d) { if (d.WEEKNUMBER % 2 !== 0) return "none"; else return "block"; })
                .attr("y", 0)
                .attr("x", -9)
                .attr("dy", ".35em")
                .attr("transform", "rotate(270)")
                .style("text-anchor", "end");

            // Add the Y Axis
            svg.append("g")
                .attr("class", "Yaxis")
                .call(d3.axisLeft(y));

        });


    </script>

</body>
</html>
